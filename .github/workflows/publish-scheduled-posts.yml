name: Publish scheduled blog posts

on:
  schedule:
    # Runs daily at 15:05 UTC (â‰ˆ 8:05 AM Denver during Standard Time)
    - cron: "5 15 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Publish any drafts dated today or earlier
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -d "_drafts" ]; then
            echo "No _drafts folder; nothing to do."
            exit 0
          fi

          mkdir -p _posts

          TODAY="$(date -u +%F)"
          echo "Today (UTC): $TODAY"

          PUBLISHED=0

          shopt -s nullglob
          for f in _drafts/*.md _drafts/*.markdown; do
            base="$(basename "$f")"

            # Expect filenames like YYYY-MM-DD-title.md
            if [[ "$base" =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})-.*\.(md|markdown)$ ]]; then
              d="${BASH_REMATCH[1]}"

              if [[ "$d" < "$TODAY" || "$d" == "$TODAY" ]]; then
                echo "Publishing: $f -> _posts/$base"
                git mv "$f" "_posts/$base"
                PUBLISHED=1
              else
                echo "Not yet: $f (date $d)"
              fi
            else
              echo "Skipping (bad filename format): $f"
            fi
          done

          if [ "$PUBLISHED" -eq 1 ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Publish scheduled blog posts"
            git push
            echo "Published posts and pushed."
          else
            echo "No posts to publish today."
          fi
