name: Publish scheduled blog posts

on:
  workflow_dispatch: {}
  schedule:
    # GitHub cron runs in UTC.
    - cron: "30 16 * * *"  # 08:30 PST (UTC-8), fixed year-round (no DST)

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Publish due posts (PST fixed, no DST)
        shell: bash
        env:
          PST_TZ: "Etc/GMT+8" # Fixed UTC-8 (PST year-round; ignores DST)
        run: |
          set -euo pipefail

          # Compute "today" in fixed PST, not UTC
          TODAY="$(TZ="$PST_TZ" date +%F)"
          echo "Today (PST fixed): $TODAY"

          # Where you stage future posts
          SCHEDULED_DIR="_scheduled"
          POSTS_DIR="_posts"

          mkdir -p "$SCHEDULED_DIR" "$POSTS_DIR"

          shopt -s nullglob

          moved=0

          for f in "$SCHEDULED_DIR"/*.md "$SCHEDULED_DIR"/*.markdown; do
            base="$(basename "$f")"

            # Expect filenames like: YYYY-MM-DD-title.md
            if [[ ! "$base" =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})-.*\.(md|markdown)$ ]]; then
              echo "Skipping (bad filename format): $f"
              continue
            fi

            file_date="${BASH_REMATCH[1]}"

            # String compare works for YYYY-MM-DD format
            if [[ "$file_date" > "$TODAY" ]]; then
              echo "Not due yet: $base (date=$file_date)"
              continue
            fi

            target="$POSTS_DIR/$base"

            if [[ -e "$target" ]]; then
              echo "Target already exists, skipping to avoid overwrite: $target"
              continue
            fi

            echo "Publishing: $base  ->  $POSTS_DIR/"
            mv "$f" "$target"
            moved=$((moved + 1))
          done

          if [[ "$moved" -eq 0 ]]; then
            echo "No posts to publish today."
            exit 0
          fi

          echo "Published $moved post(s). Committing..."

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$POSTS_DIR" "$SCHEDULED_DIR"
          git commit -m "Publish scheduled posts for $TODAY"
          git push
